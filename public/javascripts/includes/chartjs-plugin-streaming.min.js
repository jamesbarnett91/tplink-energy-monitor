/*
 * @license
 * chartjs-plugin-streaming
 * http://github.com/nagix/chartjs-plugin-streaming/
 * Version: 1.4.0
 *
 * Copyright 2018 Akihiko Kusanagi
 * Released under the MIT license
 * https://github.com/nagix/chartjs-plugin-streaming/blob/master/LICENSE.md
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("chart.js"),require("moment")):"function"==typeof define&&define.amd?define(["chart.js","moment"],t):e["chartjs-plugin-streaming"]=t(e.Chart,e.moment)}(this,function(e,t){"use strict";!function(e,p){var t,i,v=e.helpers,h=Number.MAX_SAFE_INTEGER||9007199254740991,y={millisecond:{common:!0,size:1,steps:[1,2,5,10,20,50,100,250,500]},second:{common:!0,size:1e3,steps:[1,2,5,10,30]},minute:{common:!0,size:6e4,steps:[1,2,5,10,30]},hour:{common:!0,size:36e5,steps:[1,2,3,6,12]},day:{common:!0,size:864e5,steps:[1,2,5]},week:{common:!1,size:6048e5,steps:[1,2,3,4]},month:{common:!0,size:2628e6,steps:[1,2,3]},quarter:{common:!1,size:7884e6,steps:[1,2,3,4]},year:{common:!0,size:3154e7}},g=Object.keys(y);function b(e){for(var t=g.indexOf(e)+1,i=g.length;t<i;++t)if(y[g[t]].common)return g[t]}function s(e,t,i,a){var n,r=a.time,o=r.unit||function(e,t,i,a){var n,r,o,s=g.length;for(n=g.indexOf(e);n<s-1;++n)if(o=(r=y[g[n]]).steps?r.steps[r.steps.length-1]:h,r.common&&Math.ceil((i-t)/(o*r.size))<=a)return g[n];return g[s-1]}(r.minUnit,e,t,i),s=b(o),l=v.valueOrDefault(r.stepSize,r.unitStepSize),u="week"===o&&r.isoWeekday,d=y[o],c=p(e),m=p(t+a.realtime.delay+a.realtime.refresh),f=[];for(l||(l=function(e,t,i,a){var n,r,o,s=t-e,l=y[i],u=l.size,d=l.steps;if(!d)return Math.ceil(s/(a*u));for(n=0,r=d.length;n<r&&(o=d[n],!(Math.ceil(s/(u*o))<=a));++n);return o}(e,t,o,i)),u&&(c=c.isoWeekday(u),m=m.isoWeekday(u)),c=c.startOf(u?"day":o),(m=m.startOf(u?"day":o))<t&&m.add(1,o),n=p(c),!s||u||r.round||(n.startOf(s),n.add(~~((c-n)/(d.size*l))*l,o));n<m;n.add(l,o))f.push(+n);return f.push(+n),f}void 0!==document.hidden?(t="hidden",i="visibilitychange"):void 0!==document.msHidden?(t="msHidden",i="msvisibilitychange"):void 0!==document.webkitHidden&&(t="webkitHidden",i="webkitvisibilitychange");var x={data:["x","controlPointPreviousX","controlPointNextX"],dataset:["x"],tooltip:["x","caretX"]},M={data:["y","controlPointPreviousY","controlPointNextY"],dataset:["y"],tooltip:["y","caretY"]};function w(e,t,i){var a,n,r=e._start||{},o=e._view||{},s=e._model||{};for(a=0,n=t.length;a<n;++a){var l=t[a];r.hasOwnProperty(l)&&(r[l]-=i),o.hasOwnProperty(l)&&o!==r&&(o[l]-=i),s.hasOwnProperty(l)&&s!==o&&(s[l]-=i)}}var l=e.scaleService.getScaleConstructor("time");e.scaleService.getScaleConstructor=function(e){return"time"===e&&(e="realtime"),this.constructors.hasOwnProperty(e)?this.constructors[e]:void 0};var a=l.extend({initialize:function(){l.prototype.initialize.call(this);var c=this,m=c.chart;if("time"!==c.options.type||m.options.plugins.streaming){var f=Date.now(),p=0;document.addEventListener(i,function(){document[t]||(m.update(0),f=Date.now())},!1);var h=function(){var r,e,o,t=c.options.realtime,i=t.duration,s=c.id,a=m.tooltip,n=a._active,l=1e3/(Math.max(t.frameRate,0)||30);c.isHorizontal()?(e=c.width,r=x):(e=c.height,r=M);var u=Date.now(),d=e*(u-f)/i;v.each(m.data.datasets,function(e,t){if(o=m.getDatasetMeta(t),s===o.xAxisID||s===o.yAxisID){var i,a,n=o.data||[];for(i=0,a=n.length;i<a;++i)w(n[i],r.data,d);o.dataset&&w(o.dataset,r.dataset,d)}}),n&&n[0]&&(o=m.getDatasetMeta(n[0]._datasetIndex),s!==o.xAxisID&&s!==o.yAxisID||w(a,r.tooltip,d)),c.max=c._table[1].time=u-t.delay,c.min=c._table[0].time=c.max-i,p+l<=u&&(m.animating||m.draw(),(p+=l)+l<=u&&(p=u)),f=u,v.requestAnimFrame.call(window,h)};v.requestAnimFrame.call(window,h)}},buildTicks:function(){var e=this,t=e.options;if("time"!==t.type||e.chart.options.plugins.streaming){var i=t.time,a=t.realtime,n=Date.now()-a.delay,r=n-a.duration,o=[];switch(t.ticks.source){case"data":o=e._timestamps.data;break;case"labels":o=e._timestamps.labels;break;case"auto":default:o=s(r,n,e.getLabelCapacity(r),t)}return e.min=r,e.max=n,e._unit=i.unit||function(e,t,i,a){var n,r,o=p.duration(p(a).diff(p(i)));for(n=g.length-1;n>=g.indexOf(t);n--)if(r=g[n],y[r].common&&o.as(r)>=e.length)return r;return g[t?g.indexOf(t):0]}(o,i.minUnit,e.min,e.max),e._majorUnit=b(e._unit),e._table=[{time:r,pos:0},{time:n,pos:1}],e._offsets={left:0,right:0},e._labelFormat=function(e,t){var i,a,n,r,o,s,l,u=e.length;for(i=0;i<u;i++){if(r=e[i],l=s=void 0,s=(o=t).parser,l=o.parser||o.format,0!==(a="function"==typeof s?s(r):"string"==typeof r&&"string"==typeof l?p(r,l):(r instanceof p||(r=p(r)),r.isValid()?r:"function"==typeof l?l(r):r)).millisecond())return"MMM D, YYYY h:mm:ss.SSS a";0===a.second()&&0===a.minute()&&0===a.hour()||(n=!0)}return n?"MMM D, YYYY h:mm:ss a":"MMM D, YYYY"}(e._timestamps.data,i),function(e,t){var i,a,n,r,o=[];for(i=0,a=e.length;i<a;++i)n=e[i],r=!!t&&n===+p(n).startOf(t),o.push({value:n,major:r});return o}(o,e._majorUnit)}l.prototype.buildTicks.call(this)},fit:function(){l.prototype.fit.call(this);var e=this,t=e.options;t.ticks.display&&t.display&&e.isHorizontal()&&(e.paddingLeft=3,e.paddingRight=3,e.handleMargins())},draw:function(e){var t=this.chart;if("time"===this.options.type&&!t.options.plugins.streaming)return l.prototype.draw.call(this,e);var i=this.ctx,a=this.isHorizontal()?{left:e.left,top:0,right:e.right,bottom:t.height}:{left:0,top:e.top,right:t.width,bottom:e.bottom};v.canvas.clipArea(i,a),l.prototype.draw.call(this,e),v.canvas.unclipArea(i)}});e.scaleService.registerScaleType("realtime",a,{position:"bottom",distribution:"linear",bounds:"data",time:{parser:!1,format:!1,unit:!1,round:!1,displayFormat:!1,isoWeekday:!1,minUnit:"millisecond",displayFormats:{millisecond:"h:mm:ss.SSS a",second:"h:mm:ss a",minute:"h:mm a",hour:"hA",day:"MMM D",week:"ll",month:"MMM YYYY",quarter:"[Q]Q - YYYY",year:"YYYY"}},realtime:{duration:1e4,refresh:1e3,delay:0,frameRate:30,onRefresh:null},ticks:{autoSkip:!1,source:"auto",major:{enabled:!0}}})}(e=e&&e.hasOwnProperty("default")?e.default:e,t=t&&t.hasOwnProperty("default")?t.default:t);var i=function(e){e.defaults.global.plugins.streaming={duration:1e4,refresh:1e3,delay:0,frameRate:30,onRefresh:null};var o=e.scaleService.getScaleConstructor("realtime");function s(e,t,i,a){var n,r;for(n=2,r=i.length;n<r&&e.getPixelForValue(null,n,a)<=t;++n);if(i.splice(0,n-2),"object"!=typeof i[0])return n-2}function r(n){var r,e=n.options.plugins.streaming;e.onRefresh&&e.onRefresh(n),n.data.datasets.forEach(function(e,t){var i=n.getDatasetMeta(t),a=i.controller.getScaleForId(i.xAxisID);a instanceof o&&(r=s(a,a.left,e.data,t)),(a=i.controller.getScaleForId(i.yAxisID))instanceof o&&(r=s(a,a.top,e.data,t))}),r&&n.data.labels.splice(0,r),n._bufferedRender=!0,n.update(),n._bufferedRender=!1,n._bufferedRequest=null}return{id:"streaming",afterInit:function(e,t){setInterval(function(){r(e)},t.refresh)},beforeUpdate:function(e,t){var i,a=e.options,n=a.scales;return a.elements.line.capBezierPoints=!1,n.xAxes.concat(n.yAxes).forEach(function(e){"realtime"!==e.type&&"time"!==e.type||((i=e.realtime)||(i=e.realtime={}),i.duration=t.duration,i.refresh=t.refresh,i.delay=t.delay,i.frameRate=t.frameRate,i.onRefresh=r)}),!0},beforeDraw:function(e){var t=e.lastMouseMoveEvent;return t&&e.canvas.dispatchEvent(t.native),!0},beforeEvent:function(e,t){return"mousemove"===t.type?e.lastMouseMoveEvent=t:"mouseout"===t.type&&delete e.lastMouseMoveEvent,!0}}}(e);return e.plugins.register(i),i});